{% extends "core/base.html" %}
{% load static %}

{% block title %}Reporte de Riesgos{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .card {
        border-radius: 1rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .table td, .table th {
        vertical-align: middle;
        text-align: center;
    }
    .badge {
        font-size: 0.9rem;
        padding: 0.5em 0.8em;
    }
    .bg-orange {
        background-color: #fd7e14 !important;
    }
    .text-orange {
        color: #fd7e14 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- BOTÓN VOLVER -->
    <div class="mb-3">
        <a href="{% url 'reportes' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver a Reportes
        </a>
    </div>

    <!-- ENCABEZADO -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold text-primary">Reporte de Riesgos</h2>
        <a href="?exportar=1" class="btn btn-success">
            <i class="fas fa-file-excel"></i> Exportar a Excel
        </a>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center row">
                    <div class="col-md-12 text-center mb-3 mb-md-0">
                        <h4 class="text-primary">{{ total_riesgos }}</h4>
                        <p class="text-muted mb-0">Total de Riesgos</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === RESUMEN GENERAL === -->
    <div class="row g-3 text-center mb-4">  
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>🟢 Riesgo Bajo</h5>
                    <h3>{{ riesgos_bajos }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5>🟡 Riesgo Medio</h5>
                    <h3>{{ riesgos_medios }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-orange text-white">
                <div class="card-body">
                    <h5>🟠 Riesgo Alto</h5>
                    <h3>{{ riesgos_altos }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5>🔴 Riesgo Crítico</h5>
                    <h3>{{ riesgos_criticos }}</h3>
                </div>
            </div>
        </div>
    </div>

   

    <!-- === GRÁFICO === -->
    <div class="card mb-4">
        <div class="card-body text-center">
            <h5 class="text-center mb-4">Distribución de Niveles de Riesgo</h5>
            <div style="max-width: 400px; margin: 0 auto;">
                <canvas id="chartRiesgos"></canvas>
            </div>
        </div>
    </div>

    <!-- === TABLA DE RIESGOS === -->
    <div class="card">
        <div class="card-body">
            <h5 class="text-center mb-3">Detalle de Riesgos</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover" id="riesgosTable" style="width:100%">
                    <thead class="table-light">
                        <tr class="text-nowrap">
                            <th>Nivel</th>
                            <th>Meta Asociada</th>
                            <th>Enunciado del Riesgo</th>
                            <th>Probabilidad</th>
                            <th>Impacto</th>
                            <th>Valor</th>
                            <th>Mitigaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in data %}
                        <tr>
                            <td>
                                <span class="badge bg-{{ r.color }}">{{ r.icono }} {{ r.nivel_riesgo }}</span>
                            </td>
                            <td>{{ r.meta }}</td>
                            <td class="text-start">{{ r.enunciado }}</td>
                            <td><span class="fw-bold">{{ r.probabilidad }}/10</span></td>
                            <td><span class="fw-bold">{{ r.impacto }}/10</span></td>
                            <td><span class="fw-bold text-primary">{{ r.valor_riesgo }}/100</span></td>
                            <td class="text-wrap">
                                {% if r.tiene_mitigaciones %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-shield-alt me-1"></i>{{ r.total_mitigaciones }}
                                    </span>
                                    <small class="d-block text-muted mt-1">{{ r.ultima_mitigacion   }}</small>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-exclamation-triangle me-1"></i> Sin acciones
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle fa-2x mb-2"></i><br>
                                No hay riesgos registrados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
{% if hay_datos %}
$('#riesgosTable').DataTable({
        scrollX: true,
        scrollY: '500px',
        scrollCollapse: true,
        fixedColumns: {
            left: 1,
        },
        lengthMenu: [5, 10, 15, 20, 50],
        autoWidth: false,
        paging: true,
        searching: true,
        info: true,
        pageLength: 5,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
        },
        // Configuración adicional para mejorar el rendimiento con muchas columnas
        deferRender: true,
        scroller: true,
        stateSave: true,
    });
{% endif %}
    
    const ctx = document.getElementById("chartRiesgos");
    new Chart(ctx, {
        type: "pie",
        data: {
            labels: {{ niveles_labels|safe }},
            datasets: [{
                data: {{ niveles_values|safe }},
                backgroundColor: [
                    "rgba(40, 167, 69, 0.8)",   // Verde (Bajo)
                    "rgba(255, 193, 7, 0.8)",   // Amarillo (Medio)
                    "rgba(253, 126, 20, 0.8)",  // Naranja (Alto)
                    "rgba(220, 53, 69, 0.8)"    // Rojo (Crítico)
                ],
                borderColor: [
                    "rgba(40, 167, 69, 1)",
                    "rgba(255, 193, 7, 1)",
                    "rgba(253, 126, 20, 1)",
                    "rgba(220, 53, 69, 1)"
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { 
                    position: "bottom",
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
});



</script>
{% endblock %}
