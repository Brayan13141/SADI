{% extends 'core/base.html' %}
{% load static %}

{% block title %}Avances{% endblock %}

{% block content %}
{% if request.user.role == "ADMIN" or request.user.role == "APOYO" or request.user.role == "DOCENTE" %}
<div class="container-fluid py-3">

    <!-- Botón volver -->
    <div class="mb-3">
        <a href="{% url 'gestion_metas' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver a Metas
        </a>
    </div>

    <!-- Mensajes Django -->
    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
        {% if avance_form_errors %}
    <div class="alert alert-danger">
        <strong>Errores de validación:</strong>
        <ul>
        {% for field, errors in avance_form_errors.items %}
            {% for error in errors %}
                <li>{{ field }}: {{ error }}</li>
            {% endfor %}
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <h4 class="mb-3">Meta: <strong>{{ meta.clave }}</strong> - {{ meta.nombre }}</h4>

    <h5>Avances registrados</h5>
{% if meta.acumulable %}
  <div class="alert alert-info">
    <strong>Total acumulado:</strong>
    {{ meta.total_acumulado }}{% if meta.porcentages %}%{% endif %}

    <div class="float-end">
      <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#modalInfoAcumulable">
        <i class="fas fa-info-circle me-1"></i> Ayuda
      </button>
    </div>
  </div>
  
{% endif %}

    <!-- ========== AVANCES ========== -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span>Avances</span>
            <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#modalCrearAvance">
                + Registrar
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="avancesTable" class="table table-striped table-hover table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Avance</th>
                            <th>Fecha</th>
                            <th>Departamento</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for avance in avances %}
                        <tr>
                            <td>{{ avance.id }}</td>
                            <td>{{ avance.avance_display }}</td>
                            <td>{{ avance.fecha_registro }}</td>
                            <td>{{ avance.departamento.nombre|default:"-" }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary btn-editar-avance me-1"
                                        data-id="{{ avance.id }}"
                                        data-avance="{{ avance.avance }}"
                                        data-fecha="{{ avance.fecha_registro|date:'Y-m-d' }}"
                                        data-departamento="{{ avance.departamento.id|default:'' }}">
                                    Editar
                                </button>
                                {% if request.user.role == "ADMIN" %}
                                <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                        data-bs-target="#modalEliminarAvance{{ avance.id }}">
                                    Eliminar
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>  
    </div>
</div>

<!-- ==================== MODALES ==================== -->

<!-- Crear Avance -->
<div class="modal fade" id="modalCrearAvance" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" id="formCrearAvance" novalidate>
        {% csrf_token %}
        <input type="hidden" name="crear_avance" value="1">
        <div class="modal-header">
          <h5 class="modal-title">Registrar Avance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="erroresCrearAvance" class="alert alert-danger d-none"></div>
          
          <!-- Campos ocultos del formulario Django -->
          {{ avance_form.metaCumplir }}
          {{ avance_form.departamento }}

          <!-- Campo Avance -->
          <div class="mb-3">
            <label for="{{ avance_form.avance.id_for_label }}" class="form-label">
              {{ avance_form.avance.label }}
            </label>
            {{ avance_form.avance }}
            {% if avance_form.avance.errors %}
              <div class="text-danger">
                {% for error in avance_form.avance.errors %}
                  <small>{{ error }}</small>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- Campo Fecha de Registro -->
          <div class="mb-3">
            <label for="{{ avance_form.fecha_registro.id_for_label }}" class="form-label">
              {{ avance_form.fecha_registro.label }}
            </label>
            {{ avance_form.fecha_registro }}
            {% if avance_form.fecha_registro.errors %}
              <div class="text-danger">
                {% for error in avance_form.fecha_registro.errors %}
                  <small>{{ error }}</small>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Editar Avance -->
<div class="modal fade" id="modalEditarAvance" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" id="formEditarAvance" novalidate>
        {% csrf_token %}
        <input type="hidden" name="editar_avance" value="1">
        <input type="hidden" name="avance_id" id="avance_id">
        <input type="hidden" name="metaCumplir" value="{{ meta.id }}">
        <input type="hidden" name="departamento" value="{{ meta.departamento.id }}">
        
        <div class="modal-header">
          <h5 class="modal-title">Editar Avance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="erroresEditarAvance" class="alert alert-danger d-none"></div>

          <!-- Campo Avance -->
          <div class="mb-3">
            <label class="form-label">Avance</label>
            <input type="number" step="0.01" min="0" max="100" 
                   class="form-control" id="id_avance_editar" name="avance" required>
          </div>

          <!-- Campo Fecha de Registro -->
          <div class="mb-3">
            <label class="form-label">Fecha de Registro</label>
            <input type="date" class="form-control" 
                   id="id_fecha_registro_editar" name="fecha_registro" readonly>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if meta.acumulable %}
<div class="modal fade" id="modalInfoAcumulable" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Información sobre metas acumulables</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>
          Esta meta es <strong>acumulable</strong>.  
          Al registrar un avance no debes ingresar el total, sino únicamente el valor que deseas <strong>sumar al acumulado</strong>.
        </p>
        <ul>
          <li>Ejemplo: si el acumulado actual es <strong>30</strong> y necesitas llegar a <strong>40</strong>, no pongas 40, sino <strong>10</strong>.</li>
          <li>El sistema se encarga de <strong>sumarlo automáticamente</strong> al total acumulado.</li>
        </ul>
        <div class="alert alert-secondary">
          <i class="fas fa-info-circle"></i>
          El total acumulado actual es: <strong>{{ meta.total_acumulado }}</strong>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
      </div>
    </div>
  </div>
</div>
{% endif %}


{% if request.user.role == "ADMIN" %}
<!-- Eliminar Avance (fuera de la tabla para evitar errores de DataTables) -->
{% for avance in avances %}
<div class="modal fade" id="modalEliminarAvance{{ avance.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="avance_id" value="{{ avance.id }}">
        <input type="hidden" name="eliminar_avance" value="1">
        <div class="modal-header">
          <h5 class="modal-title">Eliminar Avance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          ¿Seguro que deseas eliminar el avance <strong>ID {{ avance.id }}</strong>?
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Eliminar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>  
  </div>
</div>
{% endfor %}
{% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'JS/Metas/gestion_meta_avances.js' %}"></script>
<script>
  {% if abrir_modal_avance %}
    $(document).ready(function() {
        $('#modalCrearAvance').modal('show');
    });
    {% endif %}

  
{% endblock %}
