{% extends 'core/base.html' %}
{% block title %}Asignar valores de Metas{% endblock %}

{% block content %}
<div class="container mt-4">
    <h4>Meta: {{ meta.nombre }}</h4>

    <div class="mb-3">
        <a href="{% url 'gestion_metas' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver a Metas
        </a>

        {% if not es_docente %}
        <button class="btn btn-primary btn-sm float-end" data-bs-toggle="modal" data-bs-target="#modalCrear">
            <i class="fas fa-plus"></i> Asignar nuevo ciclo
        </button>
        {% endif %}
    </div>

    {% if messages %}
    <div class="container mt-2">
        {% for message in messages %}
        <div class="alert 
            {% if message.tags == 'error' %} alert-danger fw-bold
            {% elif message.tags == 'success' %} alert-success fw-bold
            {% elif message.tags == 'warning' %} alert-warning fw-bold
            {% else %} alert-info fw-bold {% endif %}
            shadow-sm">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Tabla de ciclos asignados -->
    <div class="table-responsive mt-3">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Ciclo</th>
                    <th>Línea base</th>
                    <th>Meta a cumplir</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for mc in metas_ciclo %}
                <tr>
                    <td>{{ mc.ciclo.nombre }}</td>
                    <td>{{ mc.lineabase_display }}</td>
                    <td>{{ mc.metacumplir_display }}</td>
                    <td>
                        {% if puede_editar %}
                        <!-- BOTÓN EDITAR -->
                        <button class="btn btn-sm btn-outline-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#modalEditar"
                                data-id="{{ mc.id }}"
                                data-ciclo="{{ mc.ciclo.id }}"
                                data-linea="{{ mc.lineabase_button }}"
                                data-meta="{{ mc.metacumplir_button }}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        {% endif %}

                        {% if not es_docente %}
                        <!-- BOTÓN ELIMINAR -->
                        <button class="btn btn-sm btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#modalEliminar"
                                data-id="{{ mc.id }}"
                                data-ciclo="{{ mc.ciclo.nombre }}">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center text-muted">No hay ciclos asignados.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Crear -->
{% if not es_docente %}
<div class="modal fade" id="modalCrear" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Asignar ciclo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          {{ form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Modal Editar -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="meta_ciclo_id" id="edit-id">
        
        <div class="modal-header">
          <h5 class="modal-title">
            {% if es_docente %}
            Editar meta comprometida
            {% else %}
            Editar ciclo asignado
            {% endif %}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          {% if not es_docente %}
          <!-- ADMIN / APOYO pueden editar todo -->
          <div class="mb-3">
            <label for="edit-ciclo" class="form-label">Ciclo</label>
            <select id="edit-ciclo" name="ciclo" class="form-select" required>
              {% for c in form.fields.ciclo.queryset %}
              <option value="{{ c.id }}">{{ c.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="edit-linea" class="form-label">Línea base</label>
            <input type="number" step="0.01" id="edit-linea" name="lineaBase" class="form-control" required>
          </div>
          {% else %}
          <input type="hidden" id="edit-ciclo" name="ciclo">
          <input type="hidden" id="edit-linea" name="lineaBase">
          {% endif %}

          <div class="mb-3">
            <label for="edit-meta" class="form-label">Meta a cumplir</label>
            <input type="number" step="0.01" id="edit-meta" name="metaCumplir" class="form-control" required>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            {% if es_docente %}Guardar{% else %}Actualizar{% endif %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="eliminar_ciclo" value="1">
        <input type="hidden" name="meta_ciclo_id" id="delete-id">
        
        <div class="modal-header">
          <h5 class="modal-title">Eliminar ciclo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-body">
          ¿Deseas eliminar el ciclo "<span id="delete-ciclo"></span>"?
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // MODAL EDITAR
    const modalEditar = document.getElementById("modalEditar");
    modalEditar.addEventListener("show.bs.modal", event => {
        const button = event.relatedTarget;
        document.getElementById("edit-id").value = button.dataset.id;
        document.getElementById("edit-ciclo").value = button.dataset.ciclo;
        document.getElementById("edit-linea").value = button.dataset.linea;
        document.getElementById("edit-meta").value = button.dataset.meta;
    });

    // MODAL ELIMINAR
    const modalEliminar = document.getElementById("modalEliminar");
    modalEliminar.addEventListener("show.bs.modal", event => {
        const button = event.relatedTarget;
        document.getElementById("delete-id").value = button.dataset.id;
        document.getElementById("delete-ciclo").textContent = button.dataset.ciclo;
    });
});
</script>
{% endblock %}  