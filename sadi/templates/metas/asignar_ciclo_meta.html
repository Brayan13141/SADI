{% extends 'core/base.html' %}
{% block title %}Asignar valores de Metas{% endblock %}

{% block content %}
<div class="container mt-4">
    <h4>Meta: {{ meta.nombre }}</h4>

  <div class="mb-3">
    <a href="{% url 'gestion_metas' %}" class="btn btn-sm btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Volver a Metas
    </a>

    {% if not es_docente %}
    <button class="btn btn-primary btn-sm float-end" data-bs-toggle="modal" data-bs-target="#modalAsignar">
      <i class="fas fa-plus"></i> Asignar nuevo ciclo
    </button>
    {% endif %}
  </div>

  {% if messages %}
  <div class="mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Tabla de ciclos asignados -->
  <div class="table-responsive mt-3">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Ciclo</th>
          <th>Línea base</th>
          <th>Meta a cumplir</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for mc in metas_ciclo %}
        <tr>
          <td>{{ mc.ciclo.nombre }}</td>
          <td>{{ mc.lineabase_display|default:"—" }}</td>
          <td>{{ mc.metacumplir_display|default:"—" }}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary"
                    data-bs-toggle="modal" data-bs-target="#modalAsignar"
                    data-meta-ciclo-id="{{ mc.id }}"
                    data-ciclo="{{ mc.ciclo.id }}"
                    data-linea="{{ mc.lineabase_button }}"
                    data-meta="{{ mc.metacumplir_button }}">
              <i class="fas fa-edit"></i> Editar
            </button>
            {% if not es_docente %}
            <button class="btn btn-sm btn-outline-danger"
                    data-bs-toggle="modal" data-bs-target="#modalEliminar"
                    data-meta-ciclo-id="{{ mc.id }}"
                    data-ciclo="{{ mc.ciclo.nombre }}">
              <i class="fas fa-trash"></i> Eliminar
            </button>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="text-center text-muted">No hay ciclos asignados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Asignar/Editar -->
<div class="modal fade" id="modalAsignar" tabindex="-1" aria-labelledby="modalAsignarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" id="form-asignar-ciclo">
        {% csrf_token %}
        <input type="hidden" name="meta_ciclo_id" id="input-meta-ciclo-id" value="">
        <input type="hidden" name="linea_base" id="hid_linea_base" value="">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAsignarLabel">
            Asignar Ciclo
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">  
          {% if not es_docente %}
          <div class="mb-3">
            <label for="{{ form.ciclo.id_for_label }}">Ciclo</label>
            {{ form.ciclo }}
          </div>
          <div class="mb-3">
            <label for="{{ form.linea_base.id_for_label }}">Línea base</label>
            {{ form.linea_base }}
          </div>
          {% endif %}
          <div class="mb-3">
            <label for="{{ form.meta_cumplir.id_for_label }}">Meta a cumplir</label>
            {{ form.meta_cumplir }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="eliminar_ciclo" value="1">
        <input type="hidden" name="meta_ciclo_id" id="input-eliminar-meta-ciclo-id">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEliminarLabel">Eliminar Ciclo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          ¿Está seguro de que desea eliminar el ciclo "<span id="ciclo-nombre-eliminar"></span>"?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Modal Asignar/Editar
  const modalAsignar = document.getElementById("modalAsignar");
  modalAsignar.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const metaCicloId = button.getAttribute("data-meta-ciclo-id");
    const cicloId = button.getAttribute("data-ciclo");
    const lineaBase = button.getAttribute("data-linea");
    const metaCumplir = button.getAttribute("data-meta");

    const metaCicloIdField = modalAsignar.querySelector("#input-meta-ciclo-id");
    const cicloField = modalAsignar.querySelector("#id_ciclo");
    const lineaField = modalAsignar.querySelector("#id_linea_base");
    const hlineaField = modalAsignar.querySelector("#hid_linea_base");
    const metaField = modalAsignar.querySelector("#id_meta_cumplir");
    const modalTitle = modalAsignar.querySelector("#modalAsignarLabel");

    if (metaCicloId) {
      modalTitle.textContent = "Editar Ciclo";
      metaCicloIdField.value = metaCicloId;
    } else {
      modalTitle.textContent = "Asignar Nuevo Ciclo";
      metaCicloIdField.value = "";
    }

    if (cicloField && cicloId) cicloField.value = cicloId;
    if (lineaField && lineaBase) lineaField.value = lineaBase;
    if (hlineaField && lineaBase) hlineaField.value = lineaBase;
    if (metaField && metaCumplir) metaField.value = metaCumplir;

  });

  // Modal Eliminar
  const modalEliminar = document.getElementById("modalEliminar");
  modalEliminar.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const metaCicloId = button.getAttribute("data-meta-ciclo-id");
    const cicloNombre = button.getAttribute("data-ciclo");

    const metaCicloIdField = modalEliminar.querySelector("#input-eliminar-meta-ciclo-id");
    const cicloNombreSpan = modalEliminar.querySelector("#ciclo-nombre-eliminar");

    metaCicloIdField.value = metaCicloId;
    cicloNombreSpan.textContent = cicloNombre;
  });

  // Limpiar formulario cuando se cierra el modal de crear/editar
  modalAsignar.addEventListener('hidden.bs.modal', function () {
    const form = modalAsignar.querySelector('#form-asignar-ciclo');
    form.reset();
    const metaCicloIdField = modalAsignar.querySelector("#input-meta-ciclo-id");
    metaCicloIdField.value = "";
  });
});
</script>
{% endblock %}